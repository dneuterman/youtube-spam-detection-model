<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
    {% include 'navigation.html' %}
    <div class="container">
        <h2>Prediction Complete!</h2>
        <button type="button" id="download-spam-btn" class="btn btn-primary">Save spam comments to be deleted</button>
        <ul class="list-group list-group-flush" id="comments-list">
        </ul>
    </div>
    <div id="json-data" style="display: none">{{ result }}</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        const jsonData = JSON.parse(document.querySelector("#json-data").textContent);
        console.log(typeof jsonData);
        console.log(jsonData);
        const commentsUl = document.querySelector("#comments-list");

        let jsonCommentsToDelete = []

        for (let i = 0; i < jsonData.length; i++) {
            const commentContent = jsonData[i]["comment"];
            const commentClassification = jsonData[i]["predicted_classification"];

            if (commentClassification === 1) {
                jsonCommentsToDelete.push(jsonData[i]);
            }

            const commentLi = document.createElement("li");
            commentLi.classList.add("list-group-item");
            const commentContentElement = document.createElement("p");
            commentContentElement.textContent = `Comment: ${commentContent}`;
            commentLi.appendChild(commentContentElement);
            const commentClassificationElement = document.createElement("p");
            commentClassificationElement.textContent = `Prediction: ${commentClassification === 1 ? "Spam" : "Not Spam"}`;
            commentLi.appendChild(commentClassificationElement);
            commentsUl.appendChild(commentLi);
        }

        jsonCommentsToDelete = JSON.stringify(jsonCommentsToDelete);

        const downloadSpamBtn = document.querySelector("#download-spam-btn");
        downloadSpamBtn.addEventListener("click", async () => {
            const fileOptions = {
                types: [
                    {
                        description: "comments to be deleted",
                        accept: {"application/json": [".json"]}
                    }
                ],
                suggestedName: "comments-to-delete.json"
            };

            const handle = await window.showSaveFilePicker(fileOptions);
            const writableStream = await handle.createWritable();
            await writableStream.write(jsonCommentsToDelete);
            await writableStream.close();

            window.location.href = window.location.href;
        })

    </script>
</body>
</html>